<!--
   vstupar.html
   
   Copyright 2015 Petr Studený <dosmanak@dosbook>
   
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2 of the License, or
   (at your option) any later version.
   
   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.
   
   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software
   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
   MA 02110-1301, USA.
   
   
-->

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
	<title>Vstupařův průvodce večerem</title>
	<meta http-equiv="content-type" content="text/html;charset=utf-8" />
	<script type="text/javascript">
	function setCookie(name, value)
	{
		/* dont ask for expiration in argument, use fiex value */
		days = 2
		var date = new Date();
		date.setTime(date.getTime()+days*24*60*60*1000); 
		var expires = "; expires=" + date.toGMTString();
		document.cookie = name+"=" + value+expires + ";path=/"; 
	}
	function getCookie(cname) {
					var name = cname + "=";
					var ca = document.cookie.split(';');
					for(var i=0; i<ca.length; i++) {
									var c = ca[i];
									while (c.charAt(0)==' ') c = c.substring(1);
									if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
					}
					return 0;
	}

	function evening()
	{
		document.write("<div id=prvni></div><div id=druhy></div>");
		c1 = new Concert("prvni",7);
		c2 = new Concert("druhy",3);
	}

	/***
	** Object concert:
	** one concert must have variables:
	**   name string
	**   rows integer
	**   price[rows] array of integers
	**   count[rows] array of integers
	** one concert must have methods:
	**   sumPrice(row)
	**   changeValBut(row, val)
	** one concert mauste have constructor
	**   new Concert(name,rows) - draw table with buttons and correct variables in it.
	**     create one concert with given name and rows.
	***/
	function Concert(_name,_rows)
	{
		this.name = _name;
		this.rows = _rows;
		this.price = new Array(this.rows).fill(0);
		this.count = new Array(this.rows).fill(0);
		this.setPrice = function(row, price)
		{
			if (isNaN(price)) { alert ("wrong call to setPrice"); return;};
			this.price[row] = price;
			//console.log(this.name+"-price"+row);
			//console.log(document.getElementById(this.name+"-price"+row));
			document.getElementById(this.name+"-price"+row).value = price;
			document.getElementById(this.name+"-sumPrice"+row).innerHTML = this.sumPrice(row);
			document.getElementById(this.name+"-totalPrice").innerHTML = this.getTotalPrice();
			setCookie(this.name+"-price"+row, price);
		}
		this.setCount = function(row, count)
		{
			if (isNaN(count)) { alert ("wrong call to setCount"); return;};
			this.count[row] = count;
			document.getElementById(this.name+"-count"+row).innerHTML = this.count[row];
			document.getElementById(this.name+"-sumPrice"+row).innerHTML = this.sumPrice(row);
			document.getElementById(this.name+"-totalPrice").innerHTML = this.getTotalPrice();
			setCookie(this.name+"-count"+row, count);
		}
		this.sumPrice = function(row)
		{
			return this.price[row]*this.count[row];
		}
		this.getTotalPrice = function()
		{
			totalPrice = 0;
			for (i=0;i<this.rows;i++)
			{
				totalPrice += this.sumPrice(i);
			}
			return totalPrice;
			
		}
		this.changeValBut = function(row,val){
			this.setCount(row,this.count[row] + val);
		}
		this.drawButton = function(row,val)
		{
			input = document.createElement("input");
			input.type = "button";
			input.class = "modifier";
			input.id = row+this.name+val;
			label = val.toString();
			if (label.charAt(0) != "-") { label = "+"+label; };
			input.value = label;
			console.log("this, pri incializaci buttonu: ",this.name);
			input.onclick = () => this.changeValBut(row,val);
			return input;
		}
		this.drawTable = function()
		{
			title = document.createElement("h2")
			title.innerHTML = this.name;
			feeTable = document.createElement("table");
			th = feeTable.insertRow();
			hprice = th.insertCell();
			hprice.innerHTML = "<b>Cena</b>";
			for (c=0; c < 5; c++){th.insertCell();};
			hcount = th.insertCell();
			hcount.innerHTML = "<b>Počet</b>";
			hsumPrice = th.insertCell();
			hsumPrice.innerHTML = "<b>Součet</b>";
			for (r=0; r < this.rows; r++){
				tr = feeTable.insertRow();
				priceCell = tr.insertCell();
				priceCellInput = document.createElement("input");
				priceCellInput.type = "text";
				priceCellInput.id = this.name+"-price"+r;
				priceCellInput.value = this.price[r];
				priceCellInput.size = 4;
				console.log("init: ",r);
				//this.r = r;				
				var that = this;
				priceCellInput.onblur = function(){
					roww = this.id.replace(/\D*/, "");
					that.setPrice(roww, this.value);
				}
				//priceCellInput.onblur = () => this.setPrice(r, priceCellInput.value);
				priceCell.appendChild(priceCellInput);
				tr.insertCell().appendChild(this.drawButton(r,-2));
				tr.insertCell().appendChild(this.drawButton(r,-1));
				tr.insertCell().appendChild(this.drawButton(r,+1));
				tr.insertCell().appendChild(this.drawButton(r,+4));
				tr.insertCell().appendChild(this.drawButton(r,+6));
				countCell = tr.insertCell();
				countCell.id = this.name+"-count"+r;
				countCell.innertHTML = this.count[r];
				sumPriceCell = tr.insertCell();
				sumPriceCell.id = this.name+"-sumPrice"+r;
				sumPriceCell.innerHTML = this.sumPrice(r);
				console.log("Processing row "+r);
			}
			sumTotaltr = feeTable.insertRow();
			sumTotaltr.innerHTML='<td></td><td></td><td></td><td></td><td></td><td></td><td>Total:</td><td id="'+this.name+'-totalPrice">0</td>';
			
			document.getElementById(this.name).appendChild(title);
			document.getElementById(this.name).appendChild(feeTable);
			
			
			/* fill from cookie */
			for (r=0; r < this.rows; r++){
				priceRow = parseInt(getCookie(this.name+"-price"+r));
				if (priceRow == 0) { priceRow = 50*r; }
				this.setPrice(r,priceRow);
				this.setCount(r,parseInt(getCookie(this.name+"-count"+r)));
			}
			
		}
		//* initialization complete, now do something *//
		this.drawTable();
	}

	</script>
</head>

<body id="main" onLoad="evening()">
	
</body>

</html>
